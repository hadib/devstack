# lib/whale
# Functions to control the configuration and operation of the whale service
# <do not include this template file in ``stack.sh``!>

# Dependencies:
# ``functions`` file
# ``SERVICE_{TENANT_NAME|PASSWORD}`` must be defined
# <list other global vars that are assumed to be defined>

# ``stack.sh`` calls the entry points in this order:
#
# install_whale
# configure_whale
# init_whale
# start_whale
# stop_whale
# cleanup_whale

# Save trace setting
XTRACE=$(set +o | grep xtrace)
set +o xtrace


# Defaults
# --------

# <define global variables here that belong to this project>

# Set up default directories
WHALE_DIR=$DEST/whale
WHALECLIENT_DIR=$DEST/python-whaleclient
WHALE_CONF_DIR=${WHALE_CONF_DIR:-/etc/whale}
WHALE_CONF=$WHALE_CONF_DIR/whale-api.conf
WHALE_CONF_NODE=$WHALE_CONF_DIR/node.xml
GRAPH_DB=$DEST/neo4j-graphdb

# Support entry points installation of console scripts
if [[ -d $WHALE_DIR/bin ]]; then
    WHALE_BIN_DIR=$WHALE_DIR/bin
else
    WHALE_BIN_DIR=/usr/local/bin
fi

# Glance connection info.  Note the port must be specified.
WHALE_HOSTPORT=${WHALE_HOSTPORT:-$SERVICE_HOST:9976}


# Entry Points
# ------------

# cleanup_whale() - Remove residual data files, anything left over from previous
# runs that a clean run would need to clean up
function cleanup_whale() {
    # kill instances (nova)
    # delete image files (glance)
    # This function intentionally left blank
    :
}

# configure_whale() - Set config files, create data dirs, etc
function configure_whale() {
    setup_develop $WHALE_DIR
}

# configure_whale() - Set config files, create data dirs, etc
function configure_whaleclient() {
    setup_develop $WHALECLIENT_DIR
}

# init_whale() - Initialize databases, etc.
function init_whale() {
    add_nova_opt "janus_host=$JANUS_API_HOST"
    add_nova_opt "janus_port=$JANUS_API_PORT"
}

# install_whale() - Collect source and prepare
function install_whale() {
    # TODO: Download and install graph database
    git_clone $WHALE_REPO $WHALE_DIR $WHALE_BRANCH
}

# install_whale() - Collect source and prepare
function install_whaleclient() {
    git_clone $WHALE_CLIENT_REPO $WHALECLIENT_DIR $WHALECLIENT_BRANCH
}

# start_whale() - Start running processes, including screen
function start_whale() {
    echo_summary "Starting graph db"
    screen_it neo4j "cd $GRAPH_DB && $GRAPH_DB/bin/neo4j console"
    sleep 5
    screen_it whale "cd $WHALE_DIR && $WHALE_DIR/bin/whale-init"
}

# stop_whale() - Stop running processes (non-screen)
function stop_whale() {
    screen -S $SCREEN_NAME -p whale -X kill
    screen -S $SCREEN_NAME -p neo4j -X kill
}

# Restore xtrace
$XTRACE
